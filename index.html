<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UJJAIN CHAT â€“ Family Group</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.11.0.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif}
        body{ background:#f0f2f5; height:100vh; display:flex; flex-direction:column; }

        /* LOGIN SCREEN */
        #login-screen{ position:fixed; inset:0; background:linear-gradient(135deg,#4267B2,#2851A3); display:flex; align-items:center; justify-content:center; z-index:100; }
        .login-card{ background:#fff; padding:40px; width:90%; max-width:350px; border-radius:20px; text-align:center; box-shadow:0 20px 40px rgba(0,0,0,.2); }
        .login-card h1{color:#4267B2; margin-bottom:10px}
        .login-card select{ width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; outline:none; font-size:16px; margin-top:15px; }
        .login-card button{ margin-top:20px; padding:12px; width:100%; border:none; border-radius:10px; background:#4267B2; color:#fff; font-weight:600; cursor:pointer; }

        /* HEADER */
        header{ background:#4267B2; color:#fff; padding:14px 18px; display:flex; justify-content:space-between; align-items:center; }
        .header-btns{ display:flex; gap:10px; }
        header button{ background:rgba(255,255,255,.2); border:none; padding:8px 12px; border-radius:8px; color:#fff; cursor:pointer; font-weight:600; }

        /* CHAT BOX */
        #chat-box{ flex:1; overflow-y:auto; padding:18px; display:flex; flex-direction:column; gap:12px; }
        .msg{ max-width:75%; display:flex; flex-direction:column; }
        .msg.me{ align-self:flex-end; text-align:right; }
        .sender{ font-size:.75rem; color:#65676b; margin-bottom:3px; font-weight:600; }
        .bubble{ padding:10px 14px; border-radius:18px; font-size:.95rem; line-height:1.4; }
        .me .bubble{ background:#0084ff; color:#fff; border-bottom-right-radius:4px; }
        .other .bubble{ background:#e4e6eb; color:#050505; border-bottom-left-radius:4px; }

        /* INPUT AREA */
        .input-area{ background:#fff; padding:12px; display:flex; gap:10px; border-top:1px solid #ddd; }
        .input-area input{ flex:1; padding:10px; border-radius:20px; border:1px solid #ddd; outline:none; background:#f0f2f5; }
        .input-area button{ padding:0 20px; border:none; border-radius:20px; background:#4267B2; color:#fff; font-weight:600; cursor:pointer; }
    </style>
</head>
<body>

<div id="login-screen">
  <div class="login-card">
    <h1>UJJAIN CHAT</h1>
    <p>Select Your Name</p>
    <select id="nameSelect">
      <option value="">-- Choose Name --</option>
      <option value="Adhyan Sarthak">Adhyan Sarthak</option>
      <option value="Sweta Kumari">Sweta Kumari</option>
      <option value="Mummy">Mummy</option>
      <option value="Papa">Papa</option>
      <option value="Ananya Anand">Ananya Anand</option>
    </select>
    <button onclick="login()">Join Family Chat</button>
  </div>
</div>

<header>
  <div>
    <h1>UJJAIN CHAT</h1>
    <p>Family Group</p>
  </div>
  <div class="header-btns">
    <button id="call-btn" onclick="toggleCall()" style="background:#25D366;">ðŸ“ž Voice Call</button>
    <button onclick="logout()">Exit</button>
  </div>
</header>

<div id="chat-box"></div>

<form class="input-area" id="chat-form">
  <input id="msg-input" placeholder="write text here" autocomplete="off">
  <button type="submit">Send</button>
</form>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCtsDXCwGOv8ym4RPn3EziO2O8zuaSDTGc",
  authDomain: "chatword-4d676.firebaseapp.com",
  projectId: "chatword-4d676",
  storageBucket: "chatword-4d676.firebasestorage.app",
  messagingSenderId: "434457097920",
  appId: "1:434457097920:web:61678bc766f8e398b35f25"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const colRef = collection(db, "family_chat");

const user = localStorage.getItem("family_user");
if (user) document.getElementById("login-screen").style.display = "none";

window.login = () => {
  const name = document.getElementById("nameSelect").value;
  if (name) {
    localStorage.setItem("family_user", name);
    location.reload();
  } else { alert("Please select a name!"); }
};

window.logout = () => { localStorage.removeItem("family_user"); location.reload(); };

// --- CHAT LOGIC ---
document.getElementById("chat-form").addEventListener("submit", async e => {
  e.preventDefault();
  const text = document.getElementById("msg-input").value.trim();
  if (text && user) {
    await addDoc(colRef, { sender: user, text: text, time: serverTimestamp() });
    document.getElementById("msg-input").value = "";
  }
});

onSnapshot(query(colRef, orderBy("time","asc")), snap => {
  const chatBox = document.getElementById("chat-box");
  chatBox.innerHTML = "";
  snap.forEach(d => {
    const m = d.data();
    const isMe = m.sender === user;
    chatBox.innerHTML += `
      <div class="msg ${isMe ? 'me' : 'other'}">
        <div class="sender">${m.sender}</div>
        <div class="bubble">${m.text}</div>
      </div>`;
  });
  chatBox.scrollTop = chatBox.scrollHeight;
});

// --- VOICE CALL LOGIC (AGORA) ---
const agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
let localTracks = { audioTrack: null };
let isCalling = false;

const agoraOptions = {
    appId: "79bdf9897e5446d3a9052d69ada91767", // Aapki App ID
    channel: "family_room",
    token: null,
    uid: null
};

window.toggleCall = async () => {
    const btn = document.getElementById("call-btn");
    if (!isCalling) {
        try {
            agoraOptions.uid = await agoraClient.join(agoraOptions.appId, agoraOptions.channel, null);
            localTracks.audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
            await agoraClient.publish([localTracks.audioTrack]);
            btn.innerText = "âŒ End Call";
            btn.style.background = "#ff4444";
            isCalling = true;
            alert("Call Joined! Ab dusre log bhi join kar sakte hain.");
        } catch (e) {
            console.error(e);
            alert("Microphone access allow karein tabhi call chalegi.");
        }
    } else {
        localTracks.audioTrack.stop();
        localTracks.audioTrack.close();
        await agoraClient.leave();
        btn.innerText = "ðŸ“ž Voice Call";
        btn.style.background = "#25D366";
        isCalling = false;
    }
};

agoraClient.on("user-published", async (remoteUser, mediaType) => {
    await agoraClient.subscribe(remoteUser, mediaType);
    if (mediaType === "audio") remoteUser.audioTrack.play();
});
</script>
</body>
</html>
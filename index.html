<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UJJAIN CHAT | FUTURE</title>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.11.0.js"></script>
    <style>
        :root { --glass: rgba(255, 255, 255, 0.15); --neon: #00f2fe; }
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', sans-serif}
        html, body { height: 100%; overflow: hidden; background: #0f2027; color: white; display: flex; flex-direction: column; }
        header { background: var(--glass); backdrop-filter: blur(15px); padding: 10px; display: flex; justify-content: space-between; align-items: center; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
        .btns { display: flex; gap: 4px; overflow-x: auto; max-width: 65%; }
        .btns button { padding: 6px 8px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.3); background: transparent; color: #fff; font-weight: 600; font-size: 9px; white-space: nowrap; cursor: pointer; }
        #video-container { display: none; grid-template-columns: 1fr 1fr; gap: 5px; padding: 5px; background: rgba(0,0,0,0.8); flex-shrink: 0; }
        .video-view { width: 100%; height: 120px; background: #000; border-radius: 10px; border: 1.5px solid var(--neon); overflow: hidden; }
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: linear-gradient(rgba(15, 32, 39, 0.9), rgba(15, 32, 39, 0.9)), url('https://www.transparenttextures.com/patterns/dark-matter.png'); -webkit-overflow-scrolling: touch; }
        .bubble { padding: 10px 15px; border-radius: 18px; max-width: 85%; font-size: 14px; backdrop-filter: blur(5px); }
        .me { align-self: flex-end; background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%); color: #000; }
        .other { align-self: flex-start; background: var(--glass); color: #fff; border: 1px solid rgba(255,255,255,0.1); }
        .input-area { background: #162a31; padding: 10px; display: flex; gap: 8px; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        .input-area input { flex: 1; padding: 12px 15px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.4); color: #fff; outline: none; font-size: 16px; }
        .send-btn { background: var(--neon); border: none; padding: 10px 15px; border-radius: 25px; color: #000; font-weight: bold; cursor: pointer; }
        #login-screen { position: fixed; inset: 0; background: #0f2027; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-card { background: var(--glass); backdrop-filter: blur(20px); padding: 25px; border-radius: 20px; text-align: center; width: 85%; border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <h2 style="color: var(--neon); text-shadow: 0 0 10px var(--neon);">UJJAIN CHAT</h2>
        <select id="nameSelect" style="width:100%; padding:12px; margin:20px 0; border-radius:10px; background:#000; color:#fff; border:1px solid var(--neon);">
            <option value="Adhyan Sarthak">Adhyan Sarthak</option>
            <option value="Sweta Kumari">Sweta Kumari</option>
            <option value="Mummy">Mummy</option>
            <option value="Papa">Papa</option>
            <option value="Ananya Anand">Ananya Anand</option>
        </select>
        <button onclick="login()" style="width:100%; padding:15px; background:var(--neon); border:none; border-radius:50px; font-weight:bold;">INITIALIZE</button>
    </div>
</div>

<header>
    <div style="display: flex; flex-direction: column;">
        <b style="color: var(--neon); font-size: 14px;">UJJAIN CHAT üè°</b>
        <small id="status" style="font-size: 8px; opacity: 0.7;">ONLINE</small>
    </div>
    <div class="btns">
        <button id="v-btn" onclick="triggerCall(true)">üìπ VIDEO</button>
        <button id="a-btn" onclick="triggerCall(false)">üìû VOICE</button>
        <button id="mute-btn" onclick="toggleMute()" style="display:none;">üé§ MUTE</button>
        <button id="end-btn" onclick="stopEverything()" style="background:#ff4444; display:none;">‚ùå END</button>
        <button onclick="logoutSystem()" style="border:none; opacity:0.6;">EXIT</button>
    </div>
</header>

<div id="video-container"></div>
<div id="chat-box"></div>
<div id="typing-box" style="padding: 2px 15px; font-size: 10px; color: var(--neon); background: rgba(0,0,0,0.3); height: 15px;"></div>

<form class="input-area" id="chat-form">
    <label style="font-size: 20px; cursor: pointer;">üñºÔ∏è<input type="file" id="img-input" accept="image/*" style="display:none" onchange="uploadImage(this)"></label>
    <input id="msg-input" placeholder="Type here..." autocomplete="off" oninput="sendTyping()">
    <button type="submit" class="send-btn">SEND</button>
</form>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCtsDXCwGOv8ym4RPn3EziO2O8zuaSDTGc",
    authDomain: "chatword-4d676.firebaseapp.com",
    projectId: "chatword-4d676",
    storageBucket: "chatword-4d676.appspot.com",
    messagingSenderId: "434457097920",
    appId: "1:434457097920:web:61678bc766f8e398b35f25"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const colRef = collection(db, "family_chat");
const user = localStorage.getItem("family_user");

// Notification & Ring Sound
const ringtone = new Audio('https://assets.mixkit.co/active_storage/sfx/1358/1358-preview.mp3');
ringtone.loop = true;

if (user) {
    document.getElementById("login-screen").style.display = "none";
    if (Notification.permission !== 'granted') Notification.requestPermission();
}

window.login = () => { localStorage.setItem("family_user", document.getElementById("nameSelect").value); location.reload(); };
window.logoutSystem = () => { if(confirm("Exit App?")) { localStorage.removeItem("family_user"); location.reload(); } };

// --- CHAT & IMAGE LOGIC ---
document.getElementById("chat-form").onsubmit = async (e) => {
    e.preventDefault();
    const val = document.getElementById("msg-input").value.trim();
    if(val) { await addDoc(colRef, { sender: user, text: val, type: 'text', time: serverTimestamp() }); document.getElementById("msg-input").value=""; }
};

window.uploadImage = async (input) => {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => { await addDoc(colRef, { sender: user, img: e.target.result, type: 'image', time: serverTimestamp() }); };
    reader.readAsDataURL(file);
};

onSnapshot(query(colRef, orderBy("time","asc")), snap => {
    const box = document.getElementById("chat-box");
    box.innerHTML = "";
    snap.forEach(d => {
        const m = d.data();
        const date = m.time ? new Date(m.time.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
        box.innerHTML += `<div class="bubble ${m.sender === user ? 'me' : 'other'}">
            <span style="font-size:9px; font-weight:bold; display:block; opacity:0.8;">${m.sender}</span>
            ${m.type === 'image' ? `<img src="${m.img}" style="max-width:100%; border-radius:10px; margin-top:5px;">` : m.text}
            <span style="font-size:8px; display:block; text-align:right; opacity:0.5;">${date}</span>
        </div>`;
    });
    box.scrollTop = box.scrollHeight;
});

// --- TYPING ---
window.sendTyping = () => {
    setDoc(doc(db, "typing", user), { typing: true, name: user, time: Date.now() });
    setTimeout(() => setDoc(doc(db, "typing", user), { typing: false }), 2000);
};

onSnapshot(collection(db, "typing"), snap => {
    let t = []; snap.forEach(d => { if(d.data().typing && d.id !== user && (Date.now() - d.data().time < 3000)) t.push(d.data().name); });
    document.getElementById("typing-box").innerText = t.length > 0 ? t.join(", ") + " typing..." : "";
});

// --- AGORA & RING SYSTEM ---
const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
let lAudio, lVideo;
let isMuted = false;

window.triggerCall = async (isVideo) => {
    await setDoc(doc(db, "call_status", "room1"), { isCalling: true, callerName: user, type: isVideo ? "VIDEO" : "VOICE", time: Date.now() });
    startCall(isVideo);
};

window.startCall = async (isVideo) => {
    await client.join("79bdf9897e5446d3a9052d69ada91767", "family_room", null);
    document.getElementById("v-btn").style.display = "none";
    document.getElementById("a-btn").style.display = "none";
    document.getElementById("end-btn").style.display = "inline-block";
    document.getElementById("mute-btn").style.display = "inline-block";
    
    lAudio = await AgoraRTC.createMicrophoneAudioTrack();
    if(isVideo) {
        lVideo = await AgoraRTC.createCameraVideoTrack();
        document.getElementById("video-container").style.display = "grid";
        const div = document.createElement("div"); div.id = "me-vid"; div.className="video-view";
        document.getElementById("video-container").appendChild(div);
        lVideo.play("me-vid"); await client.publish([lAudio, lVideo]);
    } else { await client.publish([lAudio]); }
};

// Ring Listener
onSnapshot(doc(db, "call_status", "room1"), (snapshot) => {
    const data = snapshot.data();
    if (data && data.isCalling && data.callerName !== user && (Date.now() - data.time < 30000)) {
        ringtone.play().catch(() => {});
        if (confirm(`${data.callerName} is calling! Answer?`)) {
            ringtone.pause();
            window.startCall(data.type === "VIDEO");
        }
    } else { ringtone.pause(); }
});

window.toggleMute = () => {
    isMuted = !isMuted; lAudio.setMuted(isMuted);
    document.getElementById("mute-btn").innerText = isMuted ? "üîá UNMUTE" : "üé§ MUTE";
};

window.stopEverything = async () => {
    await setDoc(doc(db, "call_status", "room1"), { isCalling: false });
    if(lAudio) { lAudio.stop(); lAudio.close(); } if(lVideo) { lVideo.stop(); lVideo.close(); }
    await client.leave(); location.reload();
};

client.on("user-published", async (u, type) => {
    await client.subscribe(u, type);
    if (type === "video") {
        document.getElementById("video-container").style.display = "grid";
        const div = document.createElement("div"); div.id = u.uid; div.className="video-view";
        document.getElementById("video-container").appendChild(div);
        u.videoTrack.play(div.id);
    }
    if (type === "audio") u.audioTrack.play();
});
client.on("user-unpublished", u => document.getElementById(u.uid)?.remove());
</script>
</body>
</html>